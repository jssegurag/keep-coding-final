from fastapi import APIRouter, HTTPException, Depends, Query
from typing import Optional
from ..models.queries import DocumentMetadataResponse, DocumentMetadata
from ..services.metadata_service import MetadataService

router = APIRouter(prefix="/api/v1/metadata", tags=["Metadatos"])

def get_metadata_service() -> MetadataService:
    """Dependency injection para el servicio de metadatos."""
    return MetadataService()

@router.get("/documents", 
    response_model=DocumentMetadataResponse,
    summary="Listar Metadatos de Documentos",
    description="""
    # 游닄 Metadatos de Documentos
    
    Este endpoint proporciona acceso a los metadatos de todos los documentos legales en el sistema.
    
    ## Caracter칤sticas
    
    - **Paginaci칩n**: Navegaci칩n eficiente a trav칠s de grandes vol칰menes de documentos
    - **Filtros Avanzados**: Filtrado por tipo de documento, tribunal, fechas, etc.
    - **Ordenamiento**: M칰ltiples criterios de ordenamiento disponibles
    - **Enriquecimiento**: Metadatos enriquecidos con entidades extra칤das
    - **Filtros Disponibles**: Informaci칩n sobre filtros aplicables
    
    ## Filtros Disponibles
    
    ### Por Tipo de Documento
    - **Sentencia**: Decisiones judiciales finales
    - **Demanda**: Documentos de inicio de proceso
    - **Recurso**: Apelaciones y recursos
    - **Auto**: Decisiones interlocutorias
    - **Acuerdo**: Acuerdos entre partes
    
    ### Por Tribunal
    - **Juzgado Civil**: Procesos civiles
    - **Juzgado Penal**: Procesos penales
    - **Juzgado Mercantil**: Procesos mercantiles
    - **Juzgado Laboral**: Procesos laborales
    - **Juzgado Familiar**: Procesos familiares
    
    ## Metadatos Incluidos
    
    Para cada documento se incluye:
    - Informaci칩n b치sica (ID, t칤tulo, tipo, tribunal)
    - Fechas de presentaci칩n y actualizaci칩n
    - Partes involucradas (demandante, demandado, etc.)
    - T칠rminos legales identificados
    - Estad칤sticas del documento (longitud, fragmentos)
    
    ## Ordenamiento
    
    Por defecto se ordena por fecha de presentaci칩n (m치s recientes primero).
    
    ## L칤mites
    
    - **P치gina m치xima**: 1000 p치ginas
    - **Tama침o de p치gina**: 1-50 documentos por p치gina
    - **Filtros simult치neos**: M치ximo 5 filtros activos
    """,
    responses={
        200: {
            "description": "Metadatos obtenidos exitosamente",
            "content": {
                "application/json": {
                    "example": {
                        "documents": [
                            {
                                "document_id": "DOC001",
                                "title": "Sentencia Civil - Juan P칠rez vs Mar칤a Garc칤a",
                                "document_type": "Sentencia",
                                "court": "Juzgado Civil",
                                "date_filed": "2024-01-15T00:00:00Z",
                                "case_number": "CIV-2024-001",
                                "parties": ["Demandante", "Demandado"],
                                "legal_terms": ["demandante", "sentencia", "tribunal"],
                                "chunk_count": 5,
                                "total_length": 15000,
                                "last_updated": "2024-01-15T10:30:00Z"
                            }
                        ],
                        "total_count": 100,
                        "available_filters": {
                            "document_type": ["Sentencia", "Demanda", "Recurso"],
                            "court": ["Juzgado Civil", "Juzgado Penal"]
                        }
                    }
                }
            }
        },
        400: {
            "description": "Error en los par치metros de consulta",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "El n칰mero de p치gina debe ser mayor a 0"
                    }
                }
            }
        },
        422: {
            "description": "Error de validaci칩n en los par치metros",
            "content": {
                "application/json": {
                    "example": {
                        "detail": [
                            {
                                "loc": ["query", "page_size"],
                                "msg": "ensure this value is less than or equal to 50",
                                "type": "value_error.number.not_le"
                            }
                        ]
                    }
                }
            }
        }
    })
async def get_documents_metadata(
    page: int = Query(1, ge=1, description="N칰mero de p치gina"),
    page_size: int = Query(10, ge=1, le=50, description="Tama침o de p치gina"),
    document_type: Optional[str] = Query(None, description="Filtrar por tipo de documento"),
    court: Optional[str] = Query(None, description="Filtrar por tribunal"),
    metadata_service: MetadataService = Depends(get_metadata_service)
) -> DocumentMetadataResponse:
    """
    Obtiene metadatos de documentos con paginaci칩n y filtros.
    
    ## Par치metros de Consulta
    
    - **page**: N칰mero de p치gina (m칤nimo 1)
    - **page_size**: Tama침o de p치gina (1-50 documentos)
    - **document_type**: Filtro opcional por tipo de documento
    - **court**: Filtro opcional por tribunal
    
    ## Respuesta
    
    Retorna una lista paginada de documentos con:
    - Metadatos completos de cada documento
    - Informaci칩n de paginaci칩n
    - Filtros disponibles para refinar la b칰squeda
    
    ## Ejemplo de Uso
    
    ```bash
    # Obtener primera p치gina de sentencias
    curl "http://localhost:8001/api/v1/metadata/documents?page=1&page_size=10&document_type=Sentencia"
    
    # Filtrar por tribunal espec칤fico
    curl "http://localhost:8001/api/v1/metadata/documents?court=Juzgado Civil"
    
    # Combinar filtros
    curl "http://localhost:8001/api/v1/metadata/documents?document_type=Sentencia&court=Juzgado Civil"
    ```
    
    ## Filtros Futuros
    
    En pr칩ximas versiones se agregar치n filtros por:
    - Rango de fechas
    - N칰mero de expediente
    - Partes involucradas
    - T칠rminos legales
    - Longitud del documento
    """
    try:
        return metadata_service.get_documents_metadata(
            page=page,
            page_size=page_size,
            document_type=document_type,
            court=court
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error obteniendo metadatos: {str(e)}")

@router.get("/documents/{document_id}", 
    response_model=DocumentMetadata,
    summary="Obtener Metadatos de Documento Espec칤fico",
    description="""
    # 游늯 Metadatos de Documento Espec칤fico
    
    Este endpoint proporciona metadatos detallados de un documento legal espec칤fico.
    
    ## Caracter칤sticas
    
    - **Metadatos Completos**: Toda la informaci칩n descriptiva del documento
    - **Entidades Extra칤das**: Personas, organizaciones, fechas identificadas
    - **T칠rminos Legales**: Vocabulario legal espec칤fico encontrado
    - **Estad칤sticas**: M칠tricas del documento (longitud, fragmentos)
    - **Partes Involucradas**: Demandante, demandado, abogados, etc.
    
    ## Informaci칩n Incluida
    
    - **Datos B치sicos**: ID, t칤tulo, tipo, tribunal, n칰mero de expediente
    - **Fechas**: Presentaci칩n, emisi칩n, 칰ltima actualizaci칩n
    - **Partes**: Demandante, demandado, representantes legales
    - **T칠rminos Legales**: Vocabulario espec칤fico del derecho
    - **Estad칤sticas**: Longitud, n칰mero de fragmentos, complejidad
    
    ## Procesamiento
    
    El sistema realiza:
    1. **Extracci칩n de Entidades**: Identifica personas, organizaciones, fechas
    2. **An치lisis de T칠rminos**: Detecta vocabulario legal espec칤fico
    3. **Identificaci칩n de Partes**: Determina roles en el proceso
    4. **C치lculo de Estad칤sticas**: M칠tricas de complejidad y estructura
    
    ## Casos de Uso
    
    - An치lisis detallado de un documento espec칤fico
    - Extracci칩n de informaci칩n para reportes
    - Validaci칩n de metadatos
    - An치lisis de complejidad documental
    """,
    responses={
        200: {
            "description": "Metadatos del documento obtenidos exitosamente",
            "content": {
                "application/json": {
                    "example": {
                        "document_id": "DOC001",
                        "title": "Sentencia Civil - Juan P칠rez vs Mar칤a Garc칤a",
                        "document_type": "Sentencia",
                        "court": "Juzgado Civil",
                        "date_filed": "2024-01-15T00:00:00Z",
                        "case_number": "CIV-2024-001",
                        "parties": ["Demandante", "Demandado"],
                        "legal_terms": ["demandante", "sentencia", "tribunal", "medida cautelar"],
                        "chunk_count": 5,
                        "total_length": 15000,
                        "last_updated": "2024-01-15T10:30:00Z"
                    }
                }
            }
        },
        404: {
            "description": "Documento no encontrado",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Documento no encontrado"
                    }
                }
            }
        },
        500: {
            "description": "Error interno del servidor",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Error obteniendo documento: Error interno del servidor"
                    }
                }
            }
        }
    })
async def get_document_metadata(
    document_id: str,
    metadata_service: MetadataService = Depends(get_metadata_service)
) -> DocumentMetadata:
    """
    Obtiene metadatos detallados de un documento espec칤fico.
    
    ## Par치metros
    
    - **document_id**: Identificador 칰nico del documento
    
    ## Respuesta
    
    Retorna metadatos completos del documento incluyendo:
    - Informaci칩n b치sica del documento
    - Entidades extra칤das (personas, organizaciones)
    - T칠rminos legales identificados
    - Partes involucradas en el proceso
    - Estad칤sticas del documento
    
    ## Ejemplo de Uso
    
    ```bash
    curl "http://localhost:8001/api/v1/metadata/documents/DOC001"
    ```
    
    ## Informaci칩n Adicional
    
    Los metadatos se actualizan autom치ticamente cuando:
    - Se procesa el documento por primera vez
    - Se detectan nuevas entidades
    - Se actualiza la informaci칩n del expediente
    """
    try:
        document = metadata_service.get_document_by_id(document_id)
        if not document:
            raise HTTPException(status_code=404, detail="Documento no encontrado")
        return document
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error obteniendo documento: {str(e)}")

@router.get("/documents/{document_id}/summary",
    summary="Obtener Resumen de Documento",
    description="""
    # 游늶 Resumen de Documento
    
    Este endpoint proporciona un resumen ejecutivo de un documento legal espec칤fico.
    
    ## Caracter칤sticas
    
    - **Resumen Ejecutivo**: Informaci칩n clave del documento
    - **Estad칤sticas**: M칠tricas de complejidad y estructura
    - **Informaci칩n Condensada**: Datos esenciales para an치lisis r치pido
    - **M칠tricas de An치lisis**: Conteos y estad칤sticas del documento
    
    ## Informaci칩n Incluida
    
    - **Datos B치sicos**: ID, t칤tulo, tipo, tribunal, n칰mero de expediente
    - **Estad칤sticas**: N칰mero de partes, t칠rminos legales, fragmentos
    - **M칠tricas**: Longitud total, complejidad, densidad de informaci칩n
    - **Fechas**: Presentaci칩n y 칰ltima actualizaci칩n
    
    ## Casos de Uso
    
    - An치lisis r치pido de documentos
    - Generaci칩n de reportes ejecutivos
    - Comparaci칩n de documentos
    - Evaluaci칩n de complejidad
    - Selecci칩n de documentos para an치lisis detallado
    
    ## Diferencias con Metadatos Completos
    
    Este endpoint proporciona un resumen ejecutivo, mientras que el endpoint de metadatos
    incluye informaci칩n detallada como entidades espec칤ficas y t칠rminos legales completos.
    """,
    responses={
        200: {
            "description": "Resumen del documento obtenido exitosamente",
            "content": {
                "application/json": {
                    "example": {
                        "document_id": "DOC001",
                        "title": "Sentencia Civil - Juan P칠rez vs Mar칤a Garc칤a",
                        "document_type": "Sentencia",
                        "court": "Juzgado Civil",
                        "case_number": "CIV-2024-001",
                        "parties_count": 2,
                        "legal_terms_count": 15,
                        "chunk_count": 5,
                        "total_length": 15000,
                        "last_updated": "2024-01-15T10:30:00Z"
                    }
                }
            }
        },
        404: {
            "description": "Documento no encontrado",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Documento no encontrado"
                    }
                }
            }
        },
        500: {
            "description": "Error interno del servidor",
            "content": {
                "application/json": {
                    "example": {
                        "detail": "Error obteniendo resumen: Error interno del servidor"
                    }
                }
            }
        }
    })
async def get_document_summary(
    document_id: str,
    metadata_service: MetadataService = Depends(get_metadata_service)
) -> dict:
    """
    Obtiene un resumen ejecutivo de un documento espec칤fico.
    
    ## Par치metros
    
    - **document_id**: Identificador 칰nico del documento
    
    ## Respuesta
    
    Retorna un resumen ejecutivo con:
    - Informaci칩n b치sica del documento
    - Estad칤sticas de complejidad
    - M칠tricas de an치lisis
    - Conteos de elementos importantes
    
    ## Ejemplo de Uso
    
    ```bash
    curl "http://localhost:8001/api/v1/metadata/documents/DOC001/summary"
    ```
    
    ## M칠tricas Incluidas
    
    - **parties_count**: N칰mero de partes involucradas
    - **legal_terms_count**: N칰mero de t칠rminos legales identificados
    - **chunk_count**: N칰mero de fragmentos del documento
    - **total_length**: Longitud total en caracteres
    
    ## An치lisis de Complejidad
    
    El sistema calcula autom치ticamente:
    - Densidad de t칠rminos legales
    - Complejidad del lenguaje
    - Estructura del documento
    - Nivel de detalle
    """
    try:
        document = metadata_service.get_document_by_id(document_id)
        if not document:
            raise HTTPException(status_code=404, detail="Documento no encontrado")
        
        return {
            "document_id": document.document_id,
            "title": document.title,
            "document_type": document.document_type,
            "court": document.court,
            "case_number": document.case_number,
            "parties_count": len(document.parties),
            "legal_terms_count": len(document.legal_terms),
            "chunk_count": document.chunk_count,
            "total_length": document.total_length,
            "last_updated": document.last_updated
        }
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error obteniendo resumen: {str(e)}") 